<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>TJA Player (ZIP only)</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  body{margin:0;background:#111;color:white;font-family:sans-serif;text-align:center}
  #top{padding:12px;background:#222;position:sticky;top:0}
  canvas{background:#000;display:block;margin:0 auto}
  button,input{font-size:16px;margin:6px}
  #status{font-size:14px;color:#8ef}
</style>
</head>
<body>

<div id="top">
  <input type="file" id="zipFile" accept=".zip,application/zip,application/x-zip-compressed">
  <button id="startBtn">START</button>
  <div id="status">ZIPを選択してください</div>
</div>

<canvas id="game" width="960" height="360"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const status = document.getElementById("status");
const startBtn = document.getElementById("startBtn");

let audioCtx = new (window.AudioContext||window.webkitAudioContext)();
let audioBuffer=null;
let bpm=120;
let offset=0;
let notes=[];
let startTime=0;
let playing=false;

/* ================= ZIP LOAD ================= */

document.getElementById("zipFile").addEventListener("change", async e=>{
  try{
    status.textContent="ZIPを解析中…";
    const file=e.target.files[0];
    const zip=await JSZip.loadAsync(file);

    // TJA探す
    let tjaFile=null;
    zip.forEach((path,entry)=>{
      if(path.toLowerCase().endsWith(".tja")) tjaFile=entry;
    });
    if(!tjaFile){ status.textContent="TJAが見つかりません"; return; }

    const tjaText=await tjaFile.async("string");

    // ヘッダ解析
    let waveFile=null;
    const lines=tjaText.split(/\r?\n/);
    for(let l of lines){
      if(l.startsWith("WAVE:")) waveFile=l.split(":")[1].trim();
      if(l.startsWith("BPM:")) bpm=parseFloat(l.split(":")[1]);
      if(l.startsWith("OFFSET:")) offset=parseFloat(l.split(":")[1]);
    }

    /* ===== COURSE解析 ===== */
    function parseCourses(text){
      const lines=text.split(/\r?\n/);
      let courses=[];
      let current=null;
      let inScore=false;

      for(let line of lines){
        line=line.trim();

        if(line.startsWith("COURSE:")){
          if(current) courses.push(current);
          current={course:line.split(":")[1].trim().toLowerCase(),score:""};
        }

        if(line==="#START"){ inScore=true; continue; }
        if(line==="#END"){ inScore=false; continue; }

        if(inScore && current) current.score+=line+"\n";
      }
      if(current) courses.push(current);
      return courses;
    }

    const courses=parseCourses(tjaText);
    if(courses.length===0){ status.textContent="譜面がありません"; return; }

    // Oni優先
    let selected=courses.find(c=>c.course==="oni");
    if(!selected) selected=courses[courses.length-1];

    parseNotes(selected.score);

    /* ===== 音源読み込み ===== */
    if(!waveFile){ status.textContent="WAVE指定がありません"; return; }

    let audioEntry=null;
    zip.forEach((path,entry)=>{
      if(path.toLowerCase().endsWith(waveFile.toLowerCase())) audioEntry=entry;
    });
    if(!audioEntry){ status.textContent="音源ファイルがZIP内にありません"; return; }

    const array=await audioEntry.async("arraybuffer");
    audioBuffer=await audioCtx.decodeAudioData(array);

    status.textContent="読み込み完了！STARTを押してください";
  }catch(err){
    console.error(err);
    status.textContent="読み込み失敗（ZIP形式を確認）";
  }
});

/* ================= 譜面解析 ================= */
function parseNotes(score){
  notes=[];
  let time=0;
  const beat=60/bpm;

  const lines=score.split(/\r?\n/);
  for(let line of lines){
    line=line.trim();
    if(line.length===0) continue;
    if(line.startsWith("#")) continue;

    const len=line.length;
    for(let i=0;i<len;i++){
      const n=line[i];
      if(n==="1"||n==="2"||n==="3"||n==="4"){
        notes.push({t:time+(beat*4/len)*i,type:n});
      }
    }
    time+=beat*4;
  }
}

/* ================= 再生 ================= */
startBtn.onclick=()=>{
  if(!audioBuffer){ status.textContent="先にZIPを読み込んでください"; return; }
  const src=audioCtx.createBufferSource();
  src.buffer=audioBuffer;
  src.connect(audioCtx.destination);
  startTime=audioCtx.currentTime+0.1-offset;
  src.start(startTime);
  playing=true;
  requestAnimationFrame(loop);
};

/* ================= 描画 ================= */
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const now=audioCtx.currentTime-startTime;
  const laneY=180;
  const hitX=200;

  // 判定枠
  ctx.fillStyle="white";
  ctx.beginPath();
  ctx.arc(hitX,laneY,30,0,Math.PI*2);
  ctx.fill();

  for(let n of notes){
    const dt=n.t-now;
    const x=hitX+dt*300;
    if(x<-50||x>canvas.width+50) continue;

    ctx.fillStyle=(n.type==="1"||n.type==="3")?"red":"blue";
    ctx.beginPath();
    ctx.arc(x,laneY,20,0,Math.PI*2);
    ctx.fill();
  }

  if(playing) requestAnimationFrame(loop);
}
</script>
</body>
</html>
